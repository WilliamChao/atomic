<!DOCTYPE html>
<html>
<head>
<title>atomic: level editor</title>

<script type="x-shader/x-vertex" id="vs_simple"> 
attribute vec2 ia_position;
uniform vec4 u_color;
varying vec4 vs_color;
const float u_rcp_field = 1.0/(2.56*2.0);
void main()
{
    //vs_color = u_color;
    vs_color = vec4(1.0, 1.0, 1.0, 0.5);
    gl_Position = vec4(ia_position*u_rcp_field, 0.0, 1.0);
}
</script>

<script type="x-shader/x-fragment" id="ps_simple">
precision mediump float;
varying vec4 vs_color;
void main()
{
    gl_FragColor = vs_color;
}
</script>

<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript">

var FieldX = 2.56;
var FieldY = 2.56;

var gl;
var ext;
var FPSTimer;
var EntitiesTimer;
var loading = false
var frame = 0;
var delay = 1000/30;
var starttime = new Date().getTime();
var mouseX = 0.5;
var mouseY = 0.5;
var oldMouseX = 0;
var oldMouseY = 0;
var mouseDx = 0;
var mouseDy = 0;

var sh_simple;
var loc_ia_position;
var vb_quad;
var ib_quad;
var ib_quad_line;

var entities = new Object();


function bool_s(v)      { return "bool("+v.toString()+")"; }
function int_s(v)       { return "int("+v.toString()+")"; }
function float_s(v)     { return "float("+v.toString()+")"; }
function vec2_s(x,y)    { return "vec2("+x.toString()+","+y.toString()+")"; }
function vec3_s(x,y,z)  { return "vec3("+x.toString()+","+y.toString()+","+z.toString()+")"; }
function vec4_s(x,y,z,w){ return "vec4("+x.toString()+","+y.toString()+","+z.toString()+","+w.toString()+")"; }
function string_s(v)    { return "string(\""+v+"\")"; }

function updateFPS() {
    document.getElementById("fps").textContent = frame;
    frame = 0;
}

function updateEntities()
{
    if(loading) { return; }

    loading = true;
    var ajax = new Ajax.Request("/state/entities",
    {
        method: "get",
        onComplete: function(res) {
            loading = false;
            eval(res.responseText);
        }
    });
}

function createShader(id)
{
  var shaderScript = document.getElementById(id);
  if (!shaderScript) {
      return null;
  }

  var str = "";
  var k = shaderScript.firstChild;
  while (k) {
      if (k.nodeType == 3)
          str += k.textContent;
      k = k.nextSibling;
  }

  var shader;
  if (shaderScript.type == "x-shader/x-fragment") {
      shader = gl.createShader(gl.FRAGMENT_SHADER);
  } else if (shaderScript.type == "x-shader/x-vertex") {
      shader = gl.createShader(gl.VERTEX_SHADER);
  } else {
      return null;
  }

  gl.shaderSource(shader, str);
  gl.compileShader(shader);

  if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
      alert(gl.getShaderInfoLog(shader));
      return null;
  }

  return shader;
}

function createShaderProgram(vsid, psid)
{
    var program = gl.createProgram();
    gl.attachShader(program, createShader(vsid));
    gl.attachShader(program, createShader(psid));
    gl.linkProgram(program);
    return program;
}

requestAnimFrame = (function() {
    return window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame ||
    function(callback, element) {
        setTimeout(callback, delay);
    };
})();


function onLoad()
{
    clearInterval(FPSTimer);
    clearInterval(EntitiesTimer);
    var c = document.getElementById("c");
    try {
        gl = c.getContext("experimental-webgl", { depth: false });
    }
    catch(e) {
    }
    if (!gl) {
        alert("WebGL is not supported on this browser.");
        return;
    }

    document.onmousemove = function(evt) {
        mouseX = evt.pageX / c.width;
        mouseY = evt.pageY / c.height;
    };

    c.onclick = function(evt) {
        mouseX = evt.pageX / c.width;
        mouseY = 1.0 - (evt.pageY / c.height);
        if(mouseX<=1.0 && mouseY<=1.0) {
            var fx = FieldX * (mouseX-0.5)*2.0;
            var fy = FieldY * (mouseY-0.5)*2.0;
            postCommand("/command", {command:"create", pos:vec2_s(fx, fy)});
        }
    };


    FPSTimer = setInterval(updateFPS, 1000);
    EntitiesTimer = setInterval(updateEntities, 1000);
    time = new Date().getTime() - starttime;

    sh_simple = createShaderProgram("vs_simple", "ps_simple");
    loc_ia_position = gl.getAttribLocation(sh_simple, "ia_position");

    var quad_vertices = new Float32Array([
        -1.0, -1.0,
        -1.0,  1.0,
         1.0,  1.0,
         1.0, -1.0
    ]);
    vb_quad = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vb_quad);
    gl.bufferData(gl.ARRAY_BUFFER, quad_vertices, gl.STATIC_DRAW);

    var quad_indices = new Int16Array([0,1,2, 2,3,0]);
    ib_quad = gl.createBuffer();
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ib_quad);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, quad_indices, gl.STATIC_DRAW);

    var quad_line_indices = new Int16Array([0,1, 1,2, 2,3, 3,0]);
    ib_quad_line = gl.createBuffer();
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ib_quad_line);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, quad_line_indices, gl.STATIC_DRAW);


    draw();
}

function draw()
{
    gl.clearColor(0.0, 0.0, 0.0, 1.0);
    gl.clear(gl.COLOR_BUFFER_BIT);

    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);

    gl.useProgram(sh_simple);
    gl.bindBuffer(gl.ARRAY_BUFFER, vb_quad);
    gl.enableVertexAttribArray(loc_ia_position);
    gl.vertexAttribPointer(loc_ia_position, 2, gl.FLOAT, gl.FALSE, 8, 0);
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ib_quad);
    gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ib_quad_line);
    gl.drawElements(gl.LINES, 8, gl.UNSIGNED_SHORT, 0);

    gl.flush();

    frame++;
    setTimeout("requestAnimFrame(draw)", delay);

    oldMouseX = mouseX;
    oldMouseY = mouseY;
}


function postCommand(url, values)
{
    var ajax = new Ajax.Request("/command",
    {
        method: "post",
        parameters: values,
        onComplete: function(res) {
        }
    });
}
</script>
</head>

<body onload="onLoad()">
<canvas id="c" width="1024" height="1024" style="position:absolute; left:0px; top:0px;"></canvas>
<div id="desc" style="position:absolute; left:1024px; top:10px;">
<span id="fps"></span>
<a href="http://primitive-games.jp/atomic/">about atomic</a>
</div>
</body>

</html>
