<!DOCTYPE html>
<html>
<head>
<title>atomic: level editor</title>

<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript">
var FieldX = 2.56;
var FieldY = 2.56;

var gl;
var ext;
var FPSTimer;
var EntitiesTimer;
var loading = false
var frame = 0;
var delay = 1000/30;
var starttime = new Date().getTime();
var mouseX = 0.5;
var mouseY = 0.5;
var oldMouseX = 0;
var oldMouseY = 0;
var mouseDx = 0;
var mouseDy = 0;


function bool_s(v) { return "bool("+v.toString()+")"; }
function int_s(v) { return "int("+v.toString()+")"; }
function float_s(v) { return "float("+v.toString()+")"; }
function vec2_s(x,y) { return "vec2("+x.toString()+","+y.toString()+")"; }
function vec3_s(x,y,z) { return "vec3("+x.toString()+","+y.toString()+","+z.toString()+")"; }
function vec4_s(x,y,z,w) { return "vec4("+x.toString()+","+y.toString()+","+z.toString()+","+w.toString()+")"; }
function string_s(v) { return "string(\""+v+"\")"; }

function updateFPS() {
	document.getElementById("fps").textContent = frame;
	frame = 0;
}

function updateEntities()
{
	if(loading) { return; }

	loading = true;
	var ajax = new Ajax.Request("/state/entities",
	{
		method: "get",
		onComplete: function(req) {
			loading = false;
		}
	});
}

requestAnimFrame = (function() {
	return window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame ||
	function(callback, element) {
		setTimeout(callback, delay);
	};
})();

function load()
{
	clearInterval(FPSTimer);
	clearInterval(EntitiesTimer);
	var c = document.getElementById("c");
	try {
		gl = c.getContext("experimental-webgl", { depth: false });
	}
	catch(e) {
	}
	if (!gl) {
		alert("WebGL is not supported on this browser.");
		return;
	}

	document.onmousemove = function(evt) {
		mouseX = evt.pageX / c.width;
		mouseY = evt.pageY / c.height;
	};

	c.onclick = function(evt) {
		mouseX = evt.pageX / c.width;
		mouseY = 1.0 - (evt.pageY / c.height);
		if(mouseX<=1.0 && mouseY<=1.0) {
			var fx = FieldX * (mouseX-0.5)*2.0;
			var fy = FieldY * (mouseY-0.5)*2.0;
			postCommand("/command", {command:"create", pos:vec2_s(fx, fy)});
		}
	};


	FPSTimer = setInterval(updateFPS, 1000);
	EntitiesTimer = setInterval(updateEntities, 1000);
	time = new Date().getTime() - starttime;

	gl.blendFunc(gl.SRC_ALPHA, gl.ONE);
	gl.clearColor(0, 0, 0, 1);

	anim();
}

function anim()
{
	gl.clearColor(0, 0, 0, 1);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

	frame++;
	setTimeout("requestAnimFrame(anim)", delay);

	oldMouseX = mouseX;
	oldMouseY = mouseY;
}


function postCommand(url, values)
{
	var ajax = new Ajax.Request("/command",
	{
		method: "post",
		parameters: values,
		onComplete: function(req) {
		}
	});
}

</script>

</head>

<body onload="load()" ondblclick="hide()">
<canvas id="c" width="1024" height="1024" style="position:absolute; left:0px; top:0px;"></canvas>
<div id="desc" style="position:absolute; left:1024px; top:10px;">
<span id="fps"></span>
<a href="http://primitive-games.jp/atomic/">about atomic</a>
</div>
</body>

</html>
